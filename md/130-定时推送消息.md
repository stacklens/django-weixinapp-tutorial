通过上两章的开发，我们已经得到一个基于云、功能完整的待办清单小程序了。

然而微信小程序版本的待办清单是有逻辑缺陷的。你想想，会用待办清单的用户大多记性不大好，那万一用户记性差到连小程序都忘了打开看看呢...此时就需要**推送消息**的辅助了：直接推送一条服务信息到微信中，让你的微信图标带个小红点，这样你总能看到了吧？







微信小程序后台 - 功能 - 订阅消息，点击开通按钮，



![todo-110-15](https://blog.dusaiphoto.com/img-sufacego3/todo-110-15.png)



进入**公共模板库**

![todo-110-16](https://blog.dusaiphoto.com/img-sufacego3/todo-110-16.png)

![todo-110-17](https://blog.dusaiphoto.com/img-sufacego3/todo-110-17.png)

![todo-110-18](https://blog.dusaiphoto.com/img-sufacego3/todo-110-18.png)

![todo-110-19](https://blog.dusaiphoto.com/img-sufacego3/todo-110-19.png)









新建云函数 `pushNotify` 





```javascript
// cloudfunctions/pushNotify/index.js

const cloud = require('wx-server-sdk')
// 初始化 cloud
cloud.init({
  // API 调用都保持和云函数当前所在环境一致
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()
const kTableName = 'todo'

// 云函数入口函数
exports.main = async (event, context) => {
  try {
    // 从云开发数据库中查询等待发送的消息列表
    const msgArr = await db
      .collection(kTableName)
      // 查询条件
      .where({
        checked: false,
        pushed: false,
      })
      .get()

    for (const msgData of msgArr.data) {
      // 发送订阅消息
      await cloud.openapi.subscribeMessage.send({
        touser: msgData._openid, // 要发送用户的openid
        page: 'pages/index/index', // 用户通过消息通知点击进入小程序的页面
        lang: 'zh_CN',
        // 订阅消息模板ID
        // 替换为你的模板id!
        templateId: 'FHKU0ktBmRAZ37iW-faAMxszRjVDFY2mvIzgH_VEerY',
        // 跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版
        // 正式版删除此行
        miniprogramState: 'developer',
        // 要发送的数据，要和模板一致
        data: {
          // 待办的主题
          thing1: {
            value: msgData.content === '' ? '无' : sliceBodyStr(msgData.content, 16)
          },
          // 待办的详情
          thing4: {
            value: '别忘了待办事项哟'
          },
        }
      })
      // 发送成功后将pushed数据状态重置
      db
        .collection(kTableName)
        .doc(msgData._id)
        .update({
          data: {
            pushed: true
          },
        })
    }
    return msgArr
  } catch (e) {
    return e
  }
}

function sliceBodyStr(str, length) {
  if (str.length <= length) {
    return str
  } else {
    return str.slice(0, length) + '...'
  }
}

// 定时触发器 
// https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html
```



记得上传







```javascript
// pages/index/index.js

Component({
  // ...
    
  methods: {
    // 修改已有的inputSubmit()方法
    // 点击提交按钮
    inputSubmit() {
      // ...
      const newItem = {
        // ...
        // 新增代码
        pushed: false
      }
      // ...
      // 新增代码
      // 订阅服务
      this.subscribe()
    },
      
    // 新增方法
    // 向用户申请推送服务
    subscribe() {
      // 填写你自己的模板id
      const templateId = 'FHKU..xxx..H_VEerY'
      // 仅展示了主流程
      // 正式环境中，需考虑到用户可能会点击‘拒绝’、‘永久拒绝’等情况
      // 并弹出对应的反馈，如弹窗等
      wx.requestSubscribeMessage({
        tmplIds: [templateId],
        success (res) {
          console.log('订阅成功 ', res)
        },
        fail (err) {
          console.log('订阅失败 ', err)
        }
      })
    },
  },
    
  // ...
})
```



`/cloudfunctions/pushNotify/config.json`

```json
{
  "permissions": {
    "openapi": ["subscribeMessage.send"]
  },
  "triggers": [{
    "name": "myTimer",
    "type": "timer",
    "config": "*/50 * * * * * *"
  }]
}
```



![todo-110-20](https://blog.dusaiphoto.com/img-sufacego3/todo-110-20.png)

![todo-110-21](https://blog.dusaiphoto.com/img-sufacego3/todo-110-21.png)

![todo-110-22](https://blog.dusaiphoto.com/img-sufacego3/todo-110-22.png)

![todo-110-23](https://blog.dusaiphoto.com/img-sufacego3/todo-110-23.png)

![todo-110-24](https://blog.dusaiphoto.com/img-sufacego3/todo-110-24.png)





```json
// 50秒一次
// "config": "*/50 * * * * * *"

// 每天上午8点一次
// "config": "0 0 8 * * * *"
```

