上一章中初步了解了微信云开发的好处，并顺利完成了向云数据库插入数据的功能。本章来试试如何**查询**和**更新**。

## 查询

为了每次启动小程序时，都能展示云数据库中的用户数据，因此需要进行列表查询。

查询功能看似简单，但首先遇到的问题就是：小程序只应该展示当前用户自己的数据，自然就牵连到如何登录和鉴权。

前面章节也说过了，云开发可以完全规避登录和鉴权的问题。但是如何操作呢？这里就要搬出大杀器了：**云函数**。





```json
// project.config.json

{
  ...,
  "cloudfunctionRoot": "cloudfunctions/"
}
```





![todo-110-10](https://blog.dusaiphoto.com/img-sufacego3/todo-110-10.png)







右键点击 `cloudfunctions/` 目录，选择**新建Node.js云函数**，创建一个叫 `getList` 的云函数如下：

![todo-110-11](https://blog.dusaiphoto.com/img-sufacego3/todo-110-11.png)



> 注意，某些版本的开发者工具并不会自动上传部署云函数。如果 `getList` 目录不是绿色的，那就右键选择**上传并部署：云端安装依赖**，云函数才会部署到云端并且生效。





```javascript
// cloudfunctions/getList/index.js

// 云函数入口文件
const cloud = require('wx-server-sdk')
cloud.init()
// 获取云数据库对象
const db = cloud.database()

// 云函数入口函数
exports.main = async (event, context) => {
  // 获取微信用户的 openID
  const openID = cloud.getWXContext().OPENID
  // 查询当前用户的所有待办数据
  const fetchResult = await db
    .collection('todo')
    .where({
      _openid: openID,
      checked: false,
    })
    .get()
  return fetchResult
}
```



注意上传部署云函数。





```javascript
// pages/index/index.js

Component({
  // ...
    
  lifetimes: {
    async attached() {
      getApp().cloud().callFunction({
        name: 'getList',
        complete: res => {
          console.log('callFunction result: ', res)
        }
      })
    },
  },
    
  // ...
})
```





![todo-110-12](https://blog.dusaiphoto.com/img-sufacego3/todo-110-12.png)







```javascript
// pages/index/index.js

Component({
  // ...
    
  lifetimes: {
    async attached() {
      getApp().cloud().callFunction({
        name: 'getList',
        complete: res => {
          this.setData({
            items: res.result.data
          })
        }
      })
    },
  },
    
  // ...
})
```





## 更新





```javascript
// cloudfunctions/updateCheck

// 云函数入口文件
const cloud = require('wx-server-sdk')
cloud.init()
// 获取云数据库对象
const db = cloud.database()

// 云函数入口函数
exports.main = async (event, context) => {
  const openID = cloud.getWXContext().OPENID
  try {
    return await db.collection('todo').where({
      id: event.id,
      _openid: openID
    })
    .update({
      data: {
        checked: event.checked
      },
    })
  } catch(e) {
    console.error(e)
  }
}
```









```javascript
// pages/index/index.js

Component({
  // ...
    
  methods: {

    // 更新待办的完成状态
    checkboxChange(e) {
      let items = JSON.parse(JSON.stringify(this.data.items))
      // 遍历items状态，找到checked状态变化的元素
      for (const [index, item] of items.entries()) {
        if (item.checked !== e.detail.value.includes(item.id)) {
          // setData动态修改数据元素的一种方式
          const key = `items[${index}].checked`
          const checked = !item.checked
          this.setData({
            // 注意这里要加括号[] 
            [key]: checked
          })
          // 调用云函数，更新数据库
          getApp().cloud().callFunction({
            name: 'updateCheck',
            data: {
              id: item.id,
              checked: checked
            }
          })
          break
        }
      }
    },
  },
    
  // ...
})
```





![todo-110-13](https://blog.dusaiphoto.com/img-sufacego3/todo-110-13.png)





![todo-110-14](https://blog.dusaiphoto.com/img-sufacego3/todo-110-14.png)